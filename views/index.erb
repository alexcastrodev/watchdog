<!-- Header -->
<div class="header-section p-4 text-center rounded-top-4">
    <h1 class="display-4 fw-bold mb-2"><i class="bi bi-shield-check me-3"></i>Watchdog</h1>
    <p class="lead mb-0">Job Monitoring Dashboard</p>
</div>

<!-- Main Content -->
<div class="p-4">
    <% 
    total_jobs = @stacks.sum { |stack_hash| stack_hash.values.first.length }
    total_stacks = @stacks.length
    jobs_with_logs = @stacks.sum { |stack_hash| stack_hash.values.first.count { |job| job[:log] } }
    %>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist" data-controller="tab">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button" role="tab" data-action="click->tab#switchTab">
                <i class="bi bi-gear"></i> Jobs
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" data-action="click->tab#switchTab">
                <i class="bi bi-file-text"></i> Logs
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="mainTabContent">
        <!-- Jobs Tab -->
        <div class="tab-pane fade show active" id="jobs" role="tabpanel">
            <% if @job_files.empty? %>
                <div class="text-center py-5">
                    <i class="bi bi-gear display-1 text-muted"></i>
                    <h3 class="mt-3 text-light">That's nice</h3>
                    <p class="text-muted">No Jobs is running</p>
                    <small class="text-muted">
                        All jobs are done
                    </small>
                </div>
            <% else %>
                <div class="row g-4">
                    <% @job_files.each do |job_file| %>
                        <div class="col-lg-6 col-xl-4">
                            <div class="card border-secondary h-100">
                                <div class="card-body">
                                    <!-- File Header -->
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h6 class="card-title mb-0 text-truncate-custom text-light" title="<%= job_file[:name] %>.yml">
                                            <i class="bi bi-file-earmark-code text-danger me-2"></i>
                                            <%= job_file[:name] %>.yml
                                        </h6>
                                        <span class="badge bg-danger">
                                            <%= (job_file[:size] / 1024.0).round(1) %> KB
                                        </span>
                                    </div>
                                    
                                    <!-- File Info -->
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i>
                                            Last modified: <%= job_file[:last_modified].strftime('%Y-%m-%d %H:%M') %>
                                        </small>
                                    </div>
                                    
                                    <!-- Content Preview -->
                                    <% if job_file[:content] && !job_file[:content].empty? %>
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-2">
                                                <i class="bi bi-eye"></i> Preview:
                                            </small>
                                            <div class="p-2 rounded" style="font-size: 0.8rem; max-height: 100px; overflow-y: auto;">
                                                <% job_file[:content].first(3).each do |key, value| %>
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <span class="property-key flex-shrink-0"><%= key %>:</span>
                                                        <span class="property-value text-truncate ms-2 path-text" style="max-width: 60%;" title="<%= value %>">
                                                            <%= value.is_a?(Hash) || value.is_a?(Array) ? "#{value.class.name.downcase}" : value %>
                                                        </span>
                                                    </div>
                                                <% end %>
                                                <% if job_file[:content].size > 3 %>
                                                    <small class="text-muted">... and <%= job_file[:content].size - 3 %> more</small>
                                                <% end %>
                                            </div>
                                        </div>
                                    <% end %>
                                    
                                    <!-- Actions -->
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-danger btn-sm" onclick="viewYamlFile('jobs', '<%= job_file[:name] %>')">
                                            <i class="bi bi-eye me-1"></i>View Details
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="viewYamlFileWithTail('jobs', '<%= job_file[:name] %>')">
                                            <i class="bi bi-play-circle me-1"></i>Tail -f
                                        </button>
                                        <a href="<%= job_file[:file_path] %>" class="btn btn-outline-light btn-sm" download>
                                            <i class="bi bi-download"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% end %>
                </div>
            <% end %>
        </div>

        <!-- Logs Tab -->
        <div class="tab-pane fade" id="logs" role="tabpanel">
            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-4 col-sm-6">
                    <div class="card border-secondary text-center h-100">
                        <div class="card-body">
                            <h2 class="text-danger fw-bold"><%= total_stacks %></h2>
                            <small class="text-muted">Active Stacks</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card border-secondary text-center h-100">
                        <div class="card-body">
                            <h2 class="text-danger fw-bold"><%= total_jobs %></h2>
                            <small class="text-muted">Total Jobs</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-sm-6">
                    <div class="card border-secondary text-center h-100">
                        <div class="card-body">
                            <h2 class="text-success fw-bold"><%= jobs_with_logs %></h2>
                            <small class="text-muted">Jobs with Logs</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stacks and Jobs -->
            <% if @stacks.empty? %>
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="mt-3 text-light">No Jobs Found</h3>
                    <p class="text-muted">Your watchdog is ready and waiting for jobs to monitor.</p>
                    <small class="text-muted">
                        Jobs will appear here once you start adding YAML configuration files to the logs directory.
                    </small>
                </div>
            <% else %>
                <div class="row g-4">
                    <% @stacks.each do |stack_hash| %>
                        <% stack_name = stack_hash.keys.first %>
                        <% jobs = stack_hash.values.first %>
                        
                        <div class="col-12">
                            <div class="card">
                                <!-- Stack Header -->
                                <div class="card-header stack-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-white">
                                        <i class="bi bi-archive me-2"></i><%= stack_name.upcase %>
                                    </h5>
                                    <span class="badge bg-light text-dark">
                                        <%= jobs.length %> job<%= jobs.length != 1 ? 's' : '' %>
                                    </span>
                                </div>
                                
                                <!-- Jobs List -->
                                <div class="card-body">
                                    <% jobs.each_with_index do |job, index| %>
                                        <div class="d-flex align-items-center justify-content-between p-3 border-bottom <%= index == jobs.length - 1 ? 'border-0' : '' %> job-row">
                                            <div class="flex-grow-1">
                                                <div class="row align-items-center">
                                                    <div class="col-md-3">
                                                        <h6 class="mb-1 text-truncate-custom" title="<%= job[:name] %>">
                                                            <i class="bi bi-box-seam me-2 text-primary"></i>
                                                            <%= job[:name] %>
                                                        </h6>
                                                        <span class="badge">
                                                            <%= job[:status] %>
                                                        </span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <% if job[:properties] && !job[:properties].empty? %>
                                                            <div class="row g-1">
                                                                <% job[:properties].first(2).each do |key, value| %>
                                                                    <div class="col-12">
                                                                        <small class="text-muted">
                                                                            <span class="property-key"><%= key %>:</span>
                                                                            <span class="property-value path-text ms-1" title="<%= value %>">
                                                                                <%= truncate_text(value.to_s, 50) %>
                                                                            </span>
                                                                        </small>
                                                                    </div>
                                                                <% end %>
                                                                <% if job[:properties].size > 2 %>
                                                                    <div class="col-12">
                                                                        <small class="text-muted">... and <%= job[:properties].size - 2 %> more properties</small>
                                                                    </div>
                                                                <% end %>
                                                            </div>
                                                        <% end %>
                                                    </div>
                                                    <div class="col-md-3 text-end">
                                                        <div class="btn-group" role="group">
                                                            <% if job[:log] %>
                                                                <button class="btn btn-outline-danger btn-sm" onclick="viewLogFile('<%= job[:name] %>')">
                                                                    <i class="bi bi-file-earmark-text me-1"></i>Log
                                                                </button>
                                                            <% end %>
                                                            <% if job[:yml_file] %>
                                                                <button class="btn btn-outline-light btn-sm" onclick="viewYamlFile('logs', '<%= job[:name] %>')">
                                                                    <i class="bi bi-file-code me-1"></i>YAML
                                                                </button>
                                                            <% end %>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                    <% end %>
                </div>
            <% end %>
        </div>


    </div>
</div>
